<html>
	<head>
		<link type="text/css" rel="stylesheet" href="assets/testjs/jasmine.css"></link>
		<script src="assets/testjs/angular.js"></script>
		<script src="assets/testjs/angular-mocks.js"></script>
		<script src="assets/testjs/jasmine-html.js"></script>
		<script src="assets/testjs/jasmine.js"></script>
	</head>
	<body>
	</body>
	<script type="text/javascript">
var app = angular.module("myApp", []);

app.controller("reservation", function($scope) {

    $scope.naomi = {
        name: 'Naomi',
        address: '1600 Amphitheatre'
    };
    $scope.igor = {
        name: 'Igor',
        address: '123 Somewhere'
    };

    $scope.user = {
        "username": String,
        "password": String,
        "userid": Number,
        "email": String,
        "budget": Number,
        "admin": Boolean
    };

    $scope.user.username = "SFellers";
    $scope.user.password = "password";
    $scope.user.userid = 0;
    $scope.user.email = "sfellers@purdue.edu";
    $scope.user.budget = 3;
    $scope.user.admin = true;

    var _slots = [
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    ];

    function _init() {
        $scope.slots = _slots;
    }

    // variables
    $scope.hours = [{
            id: 0,
            selected: "selected",
            name: "00:00 - 00:59"
        },
        {
            id: 1,
            selected: "",
            name: "01:00 - 01:59"
        },
        {
            id: 2,
            selected: "",
            name: "02:00 - 02:59"
        }

    ];
    $scope.isCollapsed = true;
    // json information delivered from SQL database (currently disposable data)
    $scope.roomsData = [{
            blocked: true,
            res: {},
            day: 1,
            roomid: 1
        },
        {
            blocked: false,
            res: [{
                    user: "Pedro",
                    start: 0,
                    end: 4,
                    shareable: false
                },
                {
                    user: "Andrew",
                    start: 7,
                    end: 8,
                    shareable: true
                }
            ],
            day: 1,
            roomid: 2
        },
        {
            blocked: true,
            res: [],
            day: 1,
            roomid: 3
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 4
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 5
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 6
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 7
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 8
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 9
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 10
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 11
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 12
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 13
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 14
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 15
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 16
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 17
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 18
        },
        {
            blocked: false,
            res: [],
            day: 1,
            roomid: 19
        }
    ];
    // name displayed at top of modal
    $scope.roomSelected;
    // index of room data in array
    $scope.roomIndex;
    // hour selected from reserve-modal serves as start time
    $scope.hourSelected;
    // available hours from selected start time
    $scope.availableHours = [];
    var _slots = [
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    ];

    function _init() {
        $scope.slots = _slots;

    }
    _init();

    // opens modal for viewing hours for a room
    $scope.openModal = function(event) {
        var id = event.target.id;
        $scope.roomSelected = id;
        var num = $scope.roomSelected.substring(4, id.length - 1);
        $scope.roomSelected = $scope.roomSelected.substring(0, id.length - 1);
        $scope.roomIndex = num;
        if ($scope.roomsData[num - 1].blocked == false) {

            var room = $scope.roomsData[num - 1];
            for (var resSlot = 0; resSlot < room.res.length; resSlot++) {
                var reservation = room.res[resSlot];
                var start = reservation.start;
                var end = reservation.end;
                for (var i = start; i <= end; i++) {
                    var name = "#roomModal." + i;
                    var htmlName = "roomModal." + i;
                }
            }
            $("#reserve-modal").modal("toggle");

        } else {
            var room = $scope.roomsData[num - 1];
            console.log("attempting to open blocked room modal.")
            if ($scope.user.admin) {
                $("#reserve-block-modal").modal("toggle");
            } else {
                alert("This room is currently blocked");
            }
            console.log("roomselected: " + $scope.roomIndex);
        }

    };

    //handles mouseover for rooms on the map
    $scope.mouseOver = function(event) {
        var room = "#room" + event + "a";
        $(room).mapster('select');
    };

    // handles mouseover for rooms on the map
    $scope.mouseLeave = function(event) {
        var room = "#room" + event + "a";
        if ($scope.roomsData[event - 1].blocked == false) {
            $(room).mapster('deselect');
        }
    };

    // permanently highlights rooms that are blocked (color change is not working)
    $scope.disableBlockedRooms = function() {
        angular.forEach($scope.roomsData, function(room, index) {
                if (room.blocked) {
                    var roomName = "#room" + room.roomid + "a";
                    var roomTable = "#room" + room.roomid + "c";
                    //                $(roomName).mapster('isSelectable',false);
                    $(roomName).mapster('set', true);
                    $(roomName).css("background-color", 'black');
                    $('#map').mapster('set_options', {
                        areas: [{
                            key: room.roomid,
                            fillColor: '000000'
                        }]
                    });
                }
            }

        );
    };

    // checks blocked status
    $scope.checkBlocked = function(id) {
        if ($scope.roomsData[id - 1].blocked) {
            var name = "#room" + id;
            return "Blocked";


        }
    };

    // opens second reservation modal
    $scope.openHours = function(event, roomSelected) {
        var hourTemplate = ["00:00-00:59", "01:00-01:59", "02:00-02:59", "03:00-03:59", "04:00-04:59", "05:00-05:59", "06:00-06:59", "07:00-07:59", "08:00-08:59", "09:00-09:59", "10:00-10:59", "11:00-11:59", "12:00-12:59", "13:00-13:59", "14:00-14:59", "15:00-15:59", "16:00-16:59", "17:00-17:59", "18:00-18:59", "19:00-19:59", "20:00-20:59", "21:00-21:59", "23:00-22:59", "23:00-23:59"];
        var startTime = event.target.id.substring(10, event.target.id.length);
        $scope.lastButtonPressed = startTime;
        $scope.hourSelected = startTime;
        var room = roomSelected;
        var roomReservations = room.res;
        var takenHours = [];
        for (var i = 0; i < roomReservations.length; i++) {
            var reservationSlot = roomReservations[i];
            var start = reservationSlot.start;
            for (start; start <= reservationSlot.end; start++) {
                takenHours.push(start);
            }
        }
        var first = 0;
        for (var i = parseInt(startTime); takenHours.includes(i) == false && i < 24; i++) {
            if (first == 0) {
                $scope.availableHours.push({
                    id: i,
                    name: hourTemplate[i],
                    selected: "selected"
                });
                first++;
            } else {
                $scope.availableHours.push({
                    id: i,
                    name: hourTemplate[i],
                    selected: ""
                });
            }
        }

        $("#reserve-input-modal").modal("toggle");
    }

    $scope.closeSecondModal = function() {
        console.log("closing");
        $("#reserve-input-modal").modal("toggle");
    }

    $scope.unblockRoom = function(id) {
        if ($scope.roomsData[id - 1].blocked) {
            var name = "#room" + id;
            alert("RoomID: " + id + " is currently blocked");
            $scope.roomsData[id - 1].blocked = false;
            //need to add a refresh function to recolor unblocked rooms
        }
    };

});
		// ---SPECS-------------------------

describe('myApp', function () {
    var scope,
    controller;
    beforeEach(function () {
        module('myApp');
    });

    describe('reservation', function () {
        beforeEach(inject(function ($rootScope, $controller) {
            scope = $rootScope.$new();
            controller = $controller('reservation', {
                '$scope': scope
            });
        }));
        it('sets the name', function () {
            expect(scope.user.username).toBe('SFellers');
        });

    });

    
});

// --- Runner -------------------------
(function () {
    var jasmineEnv = jasmine.getEnv();
    jasmineEnv.updateInterval = 1000;

    var htmlReporter = new jasmine.HtmlReporter();

    jasmineEnv.addReporter(htmlReporter);

    jasmineEnv.specFilter = function (spec) {
        return htmlReporter.specFilter(spec);
    };

    var currentWindowOnload = window.onload;

    window.onload = function () {
        if (currentWindowOnload) {
            currentWindowOnload();
        }
        execJasmine();
    };

    function execJasmine() {
        jasmineEnv.execute();
    }

})();
	</script>
</html>

